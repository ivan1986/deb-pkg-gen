<?php

namespace Ivan1986\DebBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Ivan1986\DebBundle\Entity\SysPackage;

/**
 * PackageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PackageRepository extends EntityRepository
{

    /**
     * @return SysPackage|null
     */
    public function getSystem()
    {
        return $this->_em->createQuery('SELECT p FROM Ivan1986\DebBundle\Entity\SysPackage AS p')->getOneOrNullResult();
    }

    /**
     * Список пакетов основного репозитория
     * @return Package[]
     */
    public function mainRepo()
    {
        $data = $this->_em->createQuery('SELECT p FROM Ivan1986\DebBundle\Entity\Package AS p
            WHERE p INSTANCE OF Ivan1986\DebBundle\Entity\SimplePackage')->getResult();
        $data[] = $this->getSystem();
        return $data;
    }


    /**
     * Получить для пользователя
     *
     * @param User $user
     * @return \Doctrine\ORM\QueryBuilder
     */
    public function getByUser(User $user=null)
    {
        $qb = $this->createQueryBuilder('p');
        if ($user)
            $qb->andWhere('p.user = ?1')->setParameter(1, $user->getId());
        return $qb;
    }

    /**
     * Получить по ID с проверкой пользователя
     *
     * @param $id ID репозитория
     * @param User $user пользователь
     * @return object
     */
    public function getByIdAndCheckUser($id, User $user)
    {
        return $this->findOneBy(array('id' => $id, 'user' => $user->getId()));
    }

}